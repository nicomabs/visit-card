<!DOCTYPE html>
<html lang="fr">
<head>
  <title>Carte de visite</title>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
  <meta name="mobile-web-app-capable" content="yes">
  <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
  <meta name="theme-color" content="#BFDFF0">
  <link rel="apple-touch-icon" href="./icons/icon-192.png" />
  <link rel="manifest" href="./manifest.webmanifest">
  <link rel="stylesheet" href="style.css">
  <script src="https://cdn.rawgit.com/davidshimjs/qrcodejs/gh-pages/qrcode.min.js"></script>
</head>
<body>
  <button class="card" id="businessCard">
    <div class="row clearfix">
      <div class="left big" data-hide-portrait id="tel">Téléphone</div>
      <div class="right">
        <p><span class="big" id="org">Organisation</span></p>
      </div>
    </div>
    <div class="row">
      <p><span class="big" id="firstName">Prénom</span> <span class="big" id="lastName">Nom</span></p>
    </div>
    <div class="row">
      <p class="med" data-hide-portrait id="address">Adresse</p>
    </div>
    <div class="row">
      <a id="downloadVcf" href="#" download="contact.vcf">Ajouter à Contacts</a>
    </div>
    <div class="qrcode-container" id="qrcode" aria-label="QR Code"></div>
  </button>
  <script>
    // ===== Config / Détection d'environnement =====
    const __AUTO_ENV__ = (() => {
      const isGH = location.hostname.endsWith('github.io');
      const BASE = isGH ? '/visit-card/' : '/';
      const PUBLIC_URL = location.origin + BASE;
      return { MODE: isGH ? 'dev' : 'prod', BASE, PUBLIC_URL };
    })();
    const ENV = window.__ENV || __AUTO_ENV__;
  
    // Fix bouton .vcf (nom cohérent)
    // Ton élément dans le HTML s'appelle "downloadVcf"
    const topParams = new URLSearchParams(window.location.search);
    const defaultId = topParams.get('id') || 'oriane';
  
    // ===== Utils =====
    const qs = (k) => new URL(location.href).searchParams.get(k) || '';
    const  $  = (id) => document.getElementById(id);
  
    async function init() {
      try {
        // --- 1) Charger les données ---
        const contactsUrl = ENV.BASE + 'data/contacts.json';
        const res = await fetch(contactsUrl, { cache: 'no-store' });
        if (!res.ok) throw new Error(`contacts.json HTTP  $ {res.status}`);
        const data = await res.json();
        const list = Array.isArray(data) ? data : (Array.isArray(data.contacts) ? data.contacts : []);
        if (!list.length) throw new Error('Aucun contact dans contacts.json');
  
        // --- 2) Sélection du contact ---
        const urlId = qs('id') || defaultId;
        const contact = list.find(c => String(c.id) === String(urlId)) || list[0];
        if (!contact) throw new Error('Contact introuvable');
  
        // --- 3) Injection dans le DOM ---
        const first =  $ ('firstName'), last =  $ ('lastName'), org =  $ ('org');
        const tel =  $ ('tel'), addr =  $ ('address'), dl =  $ ('downloadVcf');
  
        if (!first || !last || !org || !tel || !addr || !dl) {
          throw new Error('IDs manquants (firstName, lastName, org, tel, address, downloadVcf)');
        }
  
        first.textContent = contact.firstName || '';
        last.textContent  = contact.lastName  || '';
        org.textContent   = contact.org       || '';
        tel.textContent   = contact.tel       || '';
  
        const addressLine = [
          contact.street || '',
          [contact.postalCode, contact.city].filter(Boolean).join(' ')
        ].filter(Boolean).join(', ');
        addr.textContent = addressLine;
  
        // --- 4) Lien .vcf servi par le Service Worker ---
        dl.href = ENV.BASE + 'vcf/' + encodeURIComponent(contact.id) + '.vcf';
        dl.setAttribute('download', ` $ {(contact.firstName||'')}_ $ {(contact.lastName||'')}.vcf`);
  
        // --- 5) QR code vers l'URL canonique ---
        const shareUrl = ENV.PUBLIC_URL + '?id=' + encodeURIComponent(contact.id);
        if (window.QRCode &&  $ ('qrcode')) {
          new QRCode( $ ('qrcode'), {
            text: shareUrl,
            width: 84, height: 84,
            colorDark: "#000", colorLight: "#fff",
            correctLevel: QRCode.CorrectLevel.M
          });
        }
  
        // --- 6) Effets UI éventuels ---
        const card = document.querySelector('.card');
        if (card) {
          card.addEventListener('click', function(e) {
            e.preventDefault();
            if (!this.classList.contains('active')) {
              this.classList.add('active');
            } else {
              this.classList.add('return');
              setTimeout(() => this.classList.remove('active','return'), 800);
            }
          });
        }
      } catch (err) {
        console.error('init error', err);
      }
    }
  
    // Démarrage
    if (document.readyState === 'loading') {
      document.addEventListener('DOMContentLoaded', () => init());
    } else {
      init();
    }
  
    // Enregistrement du Service Worker (avec logs)
    if ('serviceWorker' in navigator) {
      window.addEventListener('load', () => {
        const swPath = ENV.BASE + 'sw.js';
        console.log('Attempting to register SW at', swPath);
        navigator.serviceWorker.register(swPath)
          .then(reg => {
            console.log('Service worker registered. scope=', reg.scope);
            // optionnel : log des actions d'état
            if (reg.installing) console.log('SW state: installing');
            if (reg.waiting) console.log('SW state: waiting');
            if (reg.active) console.log('SW state: active');
          })
          .catch(err => {
            console.error('SW registration failed for', swPath, err);
          });
      });
    }
  </script>
</body>
</html>