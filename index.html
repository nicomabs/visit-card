<!DOCTYPE html>
<html lang="fr">
<head>
  <title>Carte de visite</title>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
  <meta name="mobile-web-app-capable" content="yes">
  <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
  <meta name="theme-color" content="#BFDFF0">
  <link rel="apple-touch-icon" href="./icons/icon-192.png" />
  <link rel="manifest" href="/visit-card/manifest.webmanifest">
  <link rel="stylesheet" href="style.css">
  <script src="https://cdn.rawgit.com/davidshimjs/qrcodejs/gh-pages/qrcode.min.js"></script>
</head>
<body>
  <button class="card" id="businessCard">
    <div class="row clearfix">
      <div class="left big" data-hide-portrait id="tel">Téléphone</div>
      <div class="right">
        <p><span class="big" id="org">Organisation</span></p>
      </div>
    </div>
    <div class="row">
      <p><span class="big" id="firstName">Prénom</span> <span class="big" id="lastName">Nom</span></p>
    </div>
    <div class="row">
      <p class="med" data-hide-portrait id="address">Adresse</p>
    </div>
    <div class="row">
      <a id="downloadVcf" href="#" download="contact.vcf">Ajouter à Contacts</a>
    </div>
    <div class="qrcode-container" id="qrcode" aria-label="QR Code"></div>
  </button>
  <script>
    // Base GitHub Pages
    const BASE = 'https://nicomabs.github.io/visit-card/';
  
    // Utilitaires
    const qs = (k) => new URL(location.href).searchParams.get(k) || '';
    const escapeVC = (txt='') => String(txt).replace(/[,;]/g, '\\$&');
  
    // vCard 3.0 compatible iOS (CRLF requis)
    function buildVCard(c) {
      const CRLF = '\r\n';
      const now = new Date().toISOString().replace(/[-:]/g,'').split('.')[0] + 'Z';
      const adr = `;;${escapeVC(c.street)};${escapeVC(c.city)};;${escapeVC(c.postalCode)};${escapeVC(c.country)}`;
      return [
        'BEGIN:VCARD',
        'VERSION:3.0',
        `N:${escapeVC(c.lastName)};${escapeVC(c.firstName)};;;`,
        `FN:${escapeVC(c.firstName)} ${escapeVC(c.lastName)}`,
        c.title ? `TITLE:${escapeVC(c.title)}` : '',
        c.org ? `ORG:${escapeVC(c.org)}` : '',
        c.tel ? `TEL;TYPE=CELL,VOICE:${String(c.tel).replace(/\s+/g,'')}` : '',
        c.email ? `EMAIL;TYPE=INTERNET:${c.email}` : '',
        c.street || c.city || c.postalCode || c.country ? `ADR;TYPE=WORK:${adr}` : '',
        c.url ? `URL:${c.url}` : '',
        c.note ? `NOTE:${escapeVC(c.note)}` : '',
        `REV:${now}`,
        'END:VCARD'
      ].filter(Boolean).join(CRLF) + CRLF;
    }
  
    async function init() {
      try {
        
        // 1) Charger JSON
        const res = await fetch(`${BASE}data/contacts.json`, { cache: 'no-store' });
        console.log(res)
        if (!res.ok) throw new Error(`contacts.json HTTP ${res.status}`);
        let data = await res.json();

        console.log("data", data)
  
        // Accepter tableau nu ou {contacts:[...]}
        const list = Array.isArray(data) ? data : Array.isArray(data.contacts) ? data.contacts : [];
        if (!list.length) throw new Error('Aucun contact dans contacts.json');
  
        // 2) Sélection du contact: ?id=oriane (sinon 1er)
        const id = qs('id');
        const contact = (id && list.find(c => c.id === id)) || list[0];
  
        // 3) Injecter le texte (avec garde)
        const $ = (id) => document.getElementById(id);
        const first = $('firstName'), last = $('lastName'), org = $('org');
        const tel = $('tel'), addr = $('address'), dl = $('downloadVcf');
  
        if (!first || !last || !org || !tel || !addr || !dl) {
          throw new Error('IDs manquants dans le HTML (firstName, lastName, org, tel, address, downloadVcf)');
        }
  
        first.textContent = contact.firstName || '';
        last.textContent  = contact.lastName  || '';
        org.textContent   = contact.org       || '';
        tel.textContent   = contact.tel       || '';
        addr.textContent  = [contact.street, [contact.postalCode, contact.city].filter(Boolean).join(' ')].filter(Boolean).join(', ');
  
        // 4) Générer vCard + lien de téléchargement
        const vcf = buildVCard(contact);
        const blob = new Blob([vcf], { type: 'text/vcard;charset=utf-8' });
        const vcfUrl = URL.createObjectURL(blob);
        dl.href = vcfUrl;
        dl.download = `${(contact.firstName||'contact')}-${(contact.lastName||'')}.vcf`.replace(/\s+/g,'-');
  
        // 5) QR Code → URL canonique du profil sous /visit-card/
        const shareUrl = `${location.origin}${BASE}?id=${encodeURIComponent(contact.id)}`;
        if (window.QRCode && document.getElementById('qrcode')) {
          new QRCode(document.getElementById('qrcode'), {
            text: shareUrl,
            width: 84, height: 84,
            colorDark: "#000",
            colorLight: "#fff",
            correctLevel: QRCode.CorrectLevel.M
          });
        } else {
          console.warn('QRCode lib manquante ou #qrcode introuvable');
        }
  
        // 6) Auto-proposer le téléchargement si la page ouverte via QR
        // iOS bloque parfois les "click()" synthétiques ; on affiche aussi un hint visuel.
        const fromQR = !!qs('id') && !sessionStorage.getItem('vcfPrompted');
        if (fromQR) {
          sessionStorage.setItem('vcfPrompted', '1');
          setTimeout(() => {
            try { dl.click(); } catch (e) { console.warn('Auto-click bloqué par le navigateur'); }
          }, 400);
        }
  
        // 7) Effet toggle existant (optionnel)
        const card = document.querySelector('.card');
        if (card) {
          card.addEventListener('click', function(e) {
            e.preventDefault();
            if (!this.classList.contains('active')) {
              this.classList.add('active');
            } else {
              this.classList.add('return');
              setTimeout(() => this.classList.remove('active','return'), 800);
            }
          });
        }
      } catch (err) {
        console.error('[init] Erreur:', err);
        // Message minimal côté UI (facultatif)
        const dl = document.getElementById('downloadVcf');
        if (dl) dl.textContent = 'Erreur de chargement';
      }
    }
  
    // Démarrage
    document.readyState === 'loading'
      ? document.addEventListener('DOMContentLoaded', init)
      : init();
  
    // Enregistrement du service worker PWA
    if ('serviceWorker' in navigator) {
      window.addEventListener('load', () => {
        navigator.serviceWorker.register(`${BASE}sw.js`).catch(console.error);
      });
    }
  </script>
   
</body>
</html>
